# カスタムルール命名規約

このドキュメントでは、Trivyカスタムルールの命名規約を定義します。この規約に従うことで、自動的にルールを採番し、管理しやすくなります。

## 命名形式

```
AVD-AWS-CUSTOM-<連番>.rego
```

### 構成要素

1. **プレフィックス**: `AVD-AWS-CUSTOM-`（固定）
   - TrivyのオフィシャルルールID形式（`AVD-AWS-0123`）に合わせ、カスタムルールであることを明示
2. **連番**: 3桁の数字（001, 002, 003...）
3. **拡張子**: `.rego`（固定）

**注意**: ファイル名はシンプルに保ち、詳細な説明は含めません。ルールの内容はファイル内のコメントで確認できます。

## オフィシャル形式との整合性

TrivyのオフィシャルルールIDは `AVD-AWS-0123` 形式を使用しています。カスタムルールは `AVD-AWS-CUSTOM-<連番>` 形式を使用することで：

- オフィシャルルールIDと明確に区別できる
- Trivyの命名規約に準拠している
- カスタムルールであることが一目で分かる

## 連番の管理

- **連番は全体で統一管理**します（サービスごとではなく）
- 3桁の数字を使用（001, 002, 003...）
- 新しいルールを追加する際は、既存の最大連番+1を使用
- 連番は削除しない（削除したルールの連番は欠番として残す）

### 連番の確認方法

```bash
# exampleディレクトリ内の最大連番を確認
ls example/ | grep -oE '[0-9]{3}' | sort -n | tail -1
```

## ファイル名のシンプル化

ファイル名には説明を含めず、連番のみを使用します。ルールの詳細な内容は、ファイル内のコメントで確認できます。必要に応じて、AIでサマリを生成することもできます。

## 命名例

### 既存のルール

| ファイル名 | 連番 | 内容（参考） |
|-----------|------|------------|
| `AVD-AWS-CUSTOM-001.rego` | 001 | S3バケットの暗号化設定チェック |
| `AVD-AWS-CUSTOM-002.rego` | 002 | セキュリティグループの危険なポート開放チェック |
| `AVD-AWS-CUSTOM-003.rego` | 003 | IAMポリシーのワイルドカード使用チェック |
| `AVD-AWS-CUSTOM-004.rego` | 004 | RDSインスタンスのパブリックアクセスチェック |
| `AVD-AWS-CUSTOM-005.rego` | 005 | CloudTrailのログ記録設定チェック |
| `AVD-AWS-CUSTOM-006.rego` | 006 | EC2インスタンスのメタデータサービス設定チェック |

### 新しいルールの追加例

次のルールを追加する場合：

- **既存の最大連番**: 006

→ ファイル名: `AVD-AWS-CUSTOM-007.rego`

## AIによる自動採番手順

AIが新しいルールを作成する際は、以下の手順に従ってください：

1. **exampleディレクトリ内の既存ファイルを確認**
   ```bash
   ls example/AVD-AWS-CUSTOM-*.rego
   ```

2. **最大連番を取得**
   ```bash
   ls example/ | grep -oE '[0-9]{3}' | sort -n | tail -1
   ```

3. **新しい連番を決定**
   - 最大連番 + 1

4. **ファイル名を生成**
   - `AVD-AWS-CUSTOM-<連番>.rego`
   - 例: `AVD-AWS-CUSTOM-007.rego`

## ファイル内のコメント

ルールファイル内のコメントにも命名規約を反映させてください：

```rego
# カスタムルール: <サービス名>の<説明>
# このルールは、<具体的な内容>をチェックします
```

例：
```rego
# カスタムルール: S3バケットの暗号化チェック
# このルールは、S3バケットに暗号化が設定されているかをチェックします
```

## 注意事項

1. **一意性の確保**: 同じ連番を2回使用しない
2. **連番の欠番**: 削除したルールの連番は欠番として残す（再利用しない）
3. **ファイル名のシンプル化**: ファイル名には説明を含めず、連番のみを使用
4. **内容の確認**: ルールの詳細な内容は、ファイル内のコメントで確認するか、AIでサマリを生成する
5. **オフィシャルルールとの区別**: `AVD-AWS-CUSTOM-` プレフィックスを使用することで、オフィシャルルール（`AVD-AWS-`）と明確に区別する

## 更新履歴

- 2024-11-14: 初版作成
  - 初期ルール: 001-006を定義
- 2024-11-14: 命名形式をシンプル化
  - 説明部分を削除し、`aws-<サービス名>-<連番>.rego`形式に変更
- 2024-11-14: オフィシャル形式に準拠
  - `AVD-AWS-CUSTOM-<連番>.rego`形式に変更（TrivyのオフィシャルルールID形式に準拠）

